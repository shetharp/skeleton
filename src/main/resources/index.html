<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>

        html {
            font-family: "Segoe UI", "Helvetica", sans-serif;
            font-size: 10px;
            margin: 5rem;
        }

        #container {
            /*border: 1px solid brown;*/
            font-size: 2rem;
            width: 1000px;
            margin: auto;
        }

        H1 { margin-top: 0; float: left; }
        h2 { font-size: 2.5rem; color: #444444; margin: 0 0 2rem 0; }

        input {
            display: block;
            width: 100%;
            font-size: 2rem;
            margin-bottom: 2rem;
            padding: 0.5rem 0;
            color: #444444;
            outline: none;
            border: none;
            border-bottom: 4px solid #a7a7a7;
        }

        label {
            font-size: 1.5rem;
            color: #a7a7a7;
            line-height: 1.5;
        }

        .btn {
            color: #444444;
            border: 4px solid #444444;
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 0;
            width: 10rem;
            height: 5rem;
            line-height: 5rem;
            cursor: pointer;
            margin-top: 1rem;
            display: inline-block;
        }

        .btn-primary {
            color: #ffffff;
            border: 4px solid #333333;
            background: #444444;
        }

        .button{
            font-size: 2em;
            color: #444444;
            font-weight: bold;
            text-align: center;
            padding: 0;
            border: 4px solid #444444;
            width: 5rem;
            height: 5rem;
            line-height: 4rem;
            float: right;
            cursor: pointer;
        }

        #receiptList {
            clear: both;
            display: table;
            width: 100%;
        }

        .receipt {
            display: table-row;
        }

        .receiptListHeader {
            font-weight: bold;
            display: table-row;
        }

        .col {
            display: table-cell;
            padding: 1rem;
            border-bottom: 2px solid #dfdfdf;
        }

        .col-sm {
            min-width: 5rem;
            width: 10%;
        }

        .col-lg {
            /*min-width: 20rem;*/
            width: 40%;
        }

        .time {
            color: #afafaf;
        }

        .modal {
            width: 50rem;
            height: 35rem;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            background: #ffffff;
            box-shadow: 0px 5px 20px rgba(0,0,0,0.25);
            padding: 4rem 5rem 2rem 5rem;
        }

        .error {
            font-size: 1.5rem;
            font-style: italic;
            color: #FF6961;
            height: 1.5rem;
        }

        .hidden {
            display: none;
        }

        .text-right {
            text-align: right;
        }

    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        $(function(){
            const api = ""; // <- do not need a root api URL if this page is served directly by the API

            var showModal = false;

            function getTheDamTime(){
                var dt = new Date();
                var tm = "";

                if (dt.getHours() < 10)
                    tm += "0" + dt.getHours();
                else
                    tm += dt.getHours();
                tm += ":";
                if (dt.getMinutes() < 10)
                    tm += "0" + dt.getMinutes();
                else
                    tm += dt.getMinutes();
                tm += ":";
                if (dt.getSeconds() < 10)
                    tm += "0" + dt.getSeconds();
                else
                    tm += dt.getSeconds();
                return tm;
            }

            function appendReceiptRow(receiptID, tm, mrch, amnt, tgs){
                $(`
                        <div id=${receiptID} class="receipt">
                            <div class="col col-sm time">${tm}</div>
                            <div class="col col-lg merchant">${mrch}</div>
                            <div class="col col-sm amount">${amnt}</div>
                            <div class="col col-lg tags">${tgs}</div>
                            <!--<div><span class="receiptTag">t1</span></div>-->
                        </div>
                        `).appendTo($("#receiptList"));
            }

            $.getJSON(api+"/receipts", function(receipts){
                for(var i=0; i < receipts.length; i++) {
                    var receipt = receipts[i];
//                    $(`<div class="receipt">${receipt.merchantName}<div><span class="receiptTag">t1</span></div></div>`)
//                        .appendTo($("#receiptList"));

                    $(`
                        <div id=${receipt.id} class="receipt">
                            <div class="col col-sm time">${receipt.created}</div>
                            <div class="col col-lg merchant">${receipt.merchant}</div>
                            <div class="col col-sm amount">${receipt.amount}</div>
                            <div class="col col-lg tags">${receipt.tags}</div>
                            <!--<div><span class="receiptTag">t1</span></div>-->
                        </div>
                        `).appendTo($("#receiptList"));
                }

            })


            $("#add-receipt").click(function(){
                if (!showModal) {
                    // If model is currently hidden, show it.
                    $("#receipt-entry").removeClass("hidden")
                }
                showModal = !showModal
            })

            $("#cancel-receipt").click(function(){
                if (showModal) {
                    // Clear the text input values
                    $("#merchant").val("");
                    $("#amount").val("");
                    // If model is currently shown, close it.
                    $("#receipt-entry").addClass("hidden");
                }
            })

            $("#save-receipt").click(function(){
                var mrch = $("#merchant").val();
                var amnt = $("#amount").val();
                var emsg = "";
                if (mrch == "") {
                    emsg += "Merchant cannot be empty. "
                }

                if (isNaN(parseFloat(amnt)) || !isFinite(amnt)){
                    emsg += "Amount must be a number."
                }

                // If no errors, then save to database!
                if (emsg == "") {
                    $("#receipt-entry-error").text("");

                    $.ajax({
                        type: "POST",
                        url: "/receipts",
                        data: JSON.stringify({"merchant": mrch, "amount": amnt}),
                        dataType: "json",
                        contentType: "application/json",
                        success: function(receiptID){
                            var tm = getTheDamTime();
                            appendReceiptRow(receiptID, tm, mrch, amnt, "null");
                            if (showModal) {
                                // Clear the text input values
                                $("#merchant").val("");
                                $("#amount").val("");
                                // If model is currently shown, close it.
                                $("#receipt-entry").addClass("hidden");
                            }
                        },
                    });
                }
                else {
                    $("#receipt-entry-error").text(emsg);
                }
            })


        })
    </script>
</head>

<body>
<DIV id="container">
    <h1>My receipts</h1>
    <div id="add-receipt" class="button">+</div>
    <div id="receiptList">
        <div class="receiptListHeader">
            <div class="col col-sm">Time</div>
            <div class="col col-lg">Merchant</div>
            <div class="col col-sm">Amount</div>
            <div class="col col-lg">Tags</div>
        </div>
    </div>
</DIV>

<div id="receipt-entry" class="modal hidden">
    <h2>Add Receipt</h2>
    <label for="merchant">Merchant</label>
    <input id="merchant" />
    <label for="amount">Amount</label>
    <input id="amount" />
    <p id="receipt-entry-error" class="error"><br/></p>
    <div class="text-right">
        <div id="cancel-receipt" class="btn">Cancel</div>
        <div id="save-receipt" class="btn btn-primary">Save</div>
    </div>
</div>
</body>

</html>
