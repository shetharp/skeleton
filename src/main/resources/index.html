<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>

        html {
            font-family: "Segoe UI", "Helvetica", sans-serif;
            font-size: 10px;
            margin: 5rem;
            overflow: hidden;
        }

        #container {
            /*border: 1px solid brown;*/
            font-size: 2rem;
            width: 1000px;
            margin: auto;
        }

        H1 { margin-top: 0; float: left; }
        h2 { font-size: 2.5rem; color: #444444; margin: 0 0 2rem 0; }

        input {
            display: block;
            width: 100%;
            font-size: 2rem;
            margin-bottom: 2rem;
            padding: 0.5rem 0;
            color: #444444;
            outline: none;
            border: none;
            border-bottom: 4px solid #a7a7a7;
        }

        label {
            font-size: 1.5rem;
            color: #a7a7a7;
            line-height: 1.5;
        }

        .btn {
            color: #444444;
            border: 4px solid #444444;
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 0;
            width: 10rem;
            height: 5rem;
            line-height: 5rem;
            cursor: pointer;
            margin-top: 1rem;
            display: inline-block;
        }

        .btn-primary {
            color: #ffffff;
            border: 4px solid #333333;
            background: #444444;
        }

        .button{
            font-size: 2em;
            color: #444444;
            font-weight: bold;
            text-align: center;
            padding: 0;
            border: 4px solid #444444;
            width: 5rem;
            height: 5rem;
            line-height: 4rem;
            float: right;
            cursor: pointer;
        }

        #receiptList {
            clear: both;
            display: table;
            width: 100%;
        }

        .receipt {
            display: table-row;
        }

        .receiptListHeader {
            font-weight: bold;
            display: table-row;
        }

        .col {
            display: table-cell;
            padding: 1rem;
            border-bottom: 2px solid #dfdfdf;
        }

        .col-sm {
            min-width: 5rem;
            width: 10%;
        }

        .col-lg {
            /*min-width: 20rem;*/
            width: 40%;
        }

        .time {
            color: #afafaf;
        }

        .modal {
            width: 50rem;
            height: 35rem;
            opacity: 1;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);

            background: #ffffff;
            box-shadow: 0px 5px 25px 10px rgba(0,0,0,0.25);
            padding: 4rem 5rem 2rem 5rem;
            transition: all 300ms ease;
        }

        .error {
            font-size: 1.5rem;
            font-style: italic;
            color: #FF6961;
            height: 1.5rem;
        }

        .hidden {
            opacity: 0.5;
            top: -50%;
            transform: translate(-50%, -50%) scale(0.25)
        }

        .text-right {
            text-align: right;
        }

    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        $(function() {
            /* ====================================================================================================
             * GLOBAL VARIABLES
            ==================================================================================================== */
            const api = ""; // <- do not need a root api URL if this page is served directly by the API
            var hideModal = true;


            /* ====================================================================================================
             * HELPER FUNCTION
             * Get's the current time and formats it cleanly with leading zeros.
             * Returns: String in the format of HH:MM:SS
            ==================================================================================================== */
            function getTheDamTime() {
                var dt = new Date();
                var tm = "";

                if (dt.getHours() < 10)
                    tm += "0" + dt.getHours();
                else
                    tm += dt.getHours();
                tm += ":";
                if (dt.getMinutes() < 10)
                    tm += "0" + dt.getMinutes();
                else
                    tm += dt.getMinutes();
                tm += ":";
                if (dt.getSeconds() < 10)
                    tm += "0" + dt.getSeconds();
                else
                    tm += dt.getSeconds();
                return tm;
            }


            /* ====================================================================================================
             * HELPER DISPLAY FUNCTION
             * Given a receipt object, append a receipt row to the table.
             * Returns: Nothing. Side-effect: New row added to receipt list table.
            ==================================================================================================== */
            function appendReceiptRow(receipt) {
                $(`
                        <div id=${receipt.id} class="receipt">
                            <div class="col col-sm time">${receipt.created}</div>
                            <div class="col col-lg merchant">${receipt.merchant}</div>
                            <div class="col col-sm amount">${receipt.amount}</div>
                            <div class="col col-lg tags">${receipt.tags}</div>
                            <!--<div><span class="receiptTag">t1</span></div>-->
                        </div>
                        `).appendTo($("#receiptList"));
            }


            /* ====================================================================================================
             * INIT DISPLAY FUNCTION
             * First, add a "tags" property to each receipt object pulled from the database via API
             * The "tags" property for each receipt is a list of tag objects associated with the receipt
             * Next, for each tag object pulled from the database via API, add it to its corresponding receipt
             * Now, each receipt object should have its "tags" property populated with tags (if it has any)
             * Finally, for each receipt add a row to the receipts table.
             * Returns: Nothing. Side-effect: Calls appendReceiptRow which adds a row to the receipts table.
            ==================================================================================================== */
            function displayInit(receiptsData, tagsData) {
                // Give each receiptData a tags property which is a list of its tags.
                // Initialize them to empty lists
                receiptsData.forEach(function(receipt){
                    receipt.tags = [];
                });

                // For each tag, add the tag to its corresponding receipt.
                tagsData.forEach(function(tag){
                    // receiptID is indexed from 1, while the array for receipts is indexed from 0
                    var matchedReceipt = receiptsData[tag.receiptID - 1];
                    matchedReceipt.tags.push(tag);
                });

                // For each receipt, add it as a row to the frontend receipt list table
                receiptsData.forEach(function(receipt){
                    appendReceiptRow(receipt);
                });

                console.log(receiptsData);
                console.log(tagsData);
            }


            /* ====================================================================================================
             * INITIAL FUNCTION
             * Starts by accessing the receipts API endpoint.
             * Once receipts have successfully loaded, access the tags API endpoint.
             * After both receipts and tags data are loaded, display the initial frontend elements!
             * Returns: Nothing. Side-effect: Runs the displayInit function which displays frontend elements.
            ==================================================================================================== */
            $.getJSON(api + "/receipts", function (receipts) {
                // Once all of the receipts data has been loaded, get all the tags data
                $.getJSON(api + "/tags", function(tags) {
                    // Once both receipts and tags are loaded, start displaying!
                    displayInit(receipts, tags);
                })
            })


            /* ====================================================================================================
             * EVENT FUNCTION
             * Clicking the [+] add receipt button shows the receipt entry modal.
             * Returns: Nothing. Side-effect: Sets hideModal to false
            ==================================================================================================== */
            $("#add-receipt").click(function(){
                if (hideModal) {
                    // If model is currently hidden, show it.
                    $("#receipt-entry").removeClass("hidden");
                    hideModal = false;
                }
            })


            /* ====================================================================================================
             * EVENT FUNCTION
             * Clicking the [CANCEL] cancel button in the receipt entry modal clears the values of the input
             * fields and closes the modal.
             * Returns: Nothing. Side-effect: Sets showModal to false
            ==================================================================================================== */
            $("#cancel-receipt").click(function(){
                if (!hideModal) {
                    // Clear the text input values
                    $("#merchant").val("");
                    $("#amount").val("");
                    $("#receipt-entry-error").text("");

                    // If model is currently shown, close it.
                    $("#receipt-entry").addClass("hidden");
                    hideModal = true;
                }
            })

            /* ====================================================================================================
             * EVENT FUNCTION
             * Clicking the [SAVE] save button in the receipt entry modal creates an AJAX POST request to add
             * the receipt to the database. If it is successful, add the receipt as a new row in the receipt
             * list table. Then, clear the values of the input fields and closes the modal.
             * Returns: Nothing.
             * Side-effect: Adds new receipt entry in database, adds new receipt row, sets showModal to false
            ==================================================================================================== */
            $("#save-receipt").click(function(){
                var mrch = $("#merchant").val();
                var amnt = $("#amount").val();
                var emsg = "";
                if (mrch == "") {
                    emsg += "Merchant cannot be empty. "
                }

                if (isNaN(parseFloat(amnt)) || !isFinite(amnt)){
                    emsg += "Amount must be a number."
                }

                // If no errors, then save to database!
                if (emsg == "") {
                    $("#receipt-entry-error").text("");

                    $.ajax({
                        type: "POST",
                        url: "/receipts",
                        data: JSON.stringify({"merchant": mrch, "amount": amnt}),
                        dataType: "json",
                        contentType: "application/json",
                        success: function(receiptID){
                            var tm = getTheDamTime();
                            var receipt = {
                                id: receiptID,
                                created: tm,
                                merchant: mrch,
                                amount: amnt,
                                tags: []
                            }
                            appendReceiptRow(receipt);

                            if (!hideModal) {
                                // Clear the text input values
                                $("#merchant").val("");
                                $("#amount").val("");
                                // If model is currently shown, close it.
                                $("#receipt-entry").addClass("hidden");
                                hideModal = true;
                            }
                        },
                    });
                }
                else {
                    $("#receipt-entry-error").text(emsg);
                }
            })


        })
    </script>
</head>

<body>
<DIV id="container">
    <h1>My receipts</h1>
    <div id="add-receipt" class="button">+</div>
    <div id="receiptList">
        <div class="receiptListHeader">
            <div class="col col-sm">Time</div>
            <div class="col col-lg">Merchant</div>
            <div class="col col-sm">Amount</div>
            <div class="col col-lg">Tags</div>
        </div>
    </div>
</DIV>

<div id="receipt-entry" class="modal hidden">
    <h2>Add Receipt</h2>
    <label for="merchant">Merchant</label>
    <input id="merchant" />
    <label for="amount">Amount</label>
    <input id="amount" />
    <p id="receipt-entry-error" class="error"><br/></p>
    <div class="text-right">
        <div id="cancel-receipt" class="btn">Cancel</div>
        <div id="save-receipt" class="btn btn-primary">Save</div>
    </div>
</div>
</body>

</html>
